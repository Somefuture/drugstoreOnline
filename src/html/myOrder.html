<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 视图窗口，移动端特属的标签。 -->
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
    <!-- 是否启动webapp功能，会删除默认的苹果工具栏和菜单栏。 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <title>我的订单</title>
    <link type="text/css" rel="stylesheet" href="../css/normalize.css">
    <link type="text/css" rel="stylesheet" href="../css/swiper.css" />
    <link type="text/css" rel="stylesheet" href="../css/sweetalert.css" />
    <link type="text/css" rel="stylesheet" href="../css/index.css" />
    <link type="text/css" rel="stylesheet" href="../css/reset.css">
</head>
<body>
<div class="shopping_header">
    <img src="../images/tab/tab_03.png" alt="" onclick="location='shoppingCar.html'">
    <p class="title">我的订单</p>
</div>
<ul class="order_tab" onclick="active_order_tab(event)">
    <li class="all active">全部</li>
    <li class="obligation">待付款</li>
    <li class="receiving">待收货</li>
    <li class="finished">已完成</li>
    <li class="closed">待评价</li>
</ul>
<div id="order_list"></div>
<div class="footer">
    <ul class="nav">
        <li>
            <a href="index.html">
                <img src="../images/tab/tab_32.png" alt="">
                首页
            </a>
        </li>
        <li>
            <a href="store.html">
                <img src="../images/tab/tab_36.png" alt="">
                精品商城
            </a>
        </li>
        <li>
            <a href="shoppingCar.html">
                <img src="../images/tab/tab_38.png" alt="">
                我的药箱
            </a>
        </li>
        <li>
            <a href="personal.html">
                <img src="../images/tab/tab_40.png" alt="">
                个人中心
            </a>
        </li>
    </ul>
</div>
</body>
<script src="../javascript/jquery-3.2.1.min.js"></script>
<script src="../javascript/sweetalert.min.js"></script>
<script src="../javascript/swiper.min.js"></script>
<script src="../javascript/underscore-1.8.3.min.js"></script>
<script src="../javascript/util.js"></script>
<script type="text/template" id="order_list_template">
    <div class="order_lists">
        <div class="order_combine_product">
            <div class="combine_name">希诺宁成人型</div>
            <ul class="combine_lists">
                <li>
                    <div class="product_img"><img src="../images/details/home_48@3x.png" alt=""></div>
                    <div class="product_details">
                        <div class="combine_product_name">
                            冲剂
                        </div>
                        <div class="detail_content">
                            <span class="product_price">￥88.00</span>
                            <span class="original_price">￥66</span>
                            <span class="product_amount">x4</span>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="product_img"><img src="../images/details/home_48@3x.png" alt=""></div>
                    <div class="product_details">
                        <div class="combine_product_name">
                            冲剂
                        </div>
                        <div class="detail_content">
                            <span class="product_price">￥88.00</span>
                            <span class="original_price">￥66</span>
                            <span class="product_amount">x4</span>
                        </div>
                    </div>
                </li>
                <li>
                    <div class="product_img"><img src="../images/details/home_48@3x.png" alt=""></div>
                    <div class="product_details">
                        <div class="combine_product_name">
                            冲剂
                        </div>
                        <div class="detail_content">
                            <span class="product_price">￥88.00</span>
                            <span class="original_price">￥66</span>
                            <span class="product_amount">x4</span>
                        </div>
                    </div>
                </li>
            </ul>
            <div class="combine_amount">
                <span class="price">￥188</span>
                <span class="original_price">￥288</span>
                <span class="quantity">x2</span>
            </div>
        </div>
        <% var status_params = ""; %>
        <% _.each(statuses, function(status, index) { %>
            <% status_params = status_params + "&statuses[" + index + "]=" + status; %>
        <% }) %>
        <% if(success) { %>
            <% _.each(success.list, function (order) { %>
                <% var is_sku_not_exist = false; %>
                <% var StatusMap = {"pending": "待付款", "success": "待发货", "done": "已完成", "shipped": "已发货", "returning": "退款中","returned": "已退款", "failed": "付款失败", "canceled": "已取消"} %>
                <div class="order_detail">
                    <div class="detail_title">
                        订单编号：<%= order.id %>
                        <span><%= StatusMap[order.status] %></span>
                    </div>
                    <ul class="order_product" onclick="location='orderDetail.html'">
                        <% _.each(order.items, function (item) { %>
                            <% if(!item.sku) is_sku_not_exist = true; %>
                            <li>
                                <div class="product_img"><img src="../images/details/home_48@3x.png" alt=""></div>
                                <div class="product_details">
                                    <div class="product_name">
                                        <%= item.sku ? item.sku.name : "商品过期不存在" %>
                                    </div>
                                    <div class="detail_content">
                                        <span class="product_price">￥<%= item.sku ? item.sku.salesPrice : "" %></span>
                                        <span class="product_amount">x<%= item.quantity %></span>
                                    </div>
                                </div>
                            </li>
                        <% }); %>
                    </ul>
                    <div class="order_amount">
                        共<%= order.items.length %>件商品 总价（含运费￥<%= order.deliveryCost %>）
                        <span class="price">￥<%= order.payment %></span>
                        <div class="operation">
                            <% if(!is_sku_not_exist && order.status === "pending") %>
                                <button class="to_pay" onclick="to_pay(<%= order.id %>)">去支付</button>
                            <% else if(order.status === "success" || order.status === "shipped") { %>
                                <button class="done" onclick="order_done(<%= order.id %>)">确认收货</button>
                            <% } %>
                        </div>
                    </div>
                </div>
            <% }); %>
            <% if(drop < success.count){ %>
                <a href="/product/orders/by_self?drop=<%=drop%>&take=10<%=status_params%>" class="bottom_info">--- 下拉加载更多数据 ---</a>
            <% } else { %>
                <span class="bottom_info">--- 已全部加载完毕 ---</span>
            <% } %>
        <% } else { %>
            <a href="/product/orders/by_self?drop=0&take=10<%=status_params%>" class="bottom_info hidden">--- 下拉加载更多数据 ---</a>
        <% } %>
    </div>
</script>
<script>
    var active_order_statuses = [];
    var template = _.template($("#order_list_template").html());
    load_orders();

    function load_orders() {
        $("#order_list").html(template({success: null, statuses: active_order_statuses}));
        scroll_load_more("#order_list", template, "a.bottom_info", {statuses: active_order_statuses});
    }

    function active_order_tab(e) {
        if(e.target.tagName === "LI") {
            if(!$(e.target).hasClass("active")) {
                $(".order_tab > li.active").each(function () {
                    $(this).removeClass("active");
                });
                $(e.target).addClass("active");
                if(e.target.innerText === "全部") {
                    active_order_statuses = [];
                }else if(e.target.innerText === "待付款") {
                    active_order_statuses = ["pending"];
                }else if(e.target.innerText === "待收货") {
                    active_order_statuses = ["success", "shipped"];
                }else if(e.target.innerText === "已完成") {
                    active_order_statuses = ["done"];
                }
            }
            load_orders();
        }
    }

    function to_pay(orderID) {
        ajax({
            type: "post",
            url: "/product/order/pay",
            data: {"orderID": orderID},
            success: function () {
                window.location.href = json.success;
            }
        });
    }

    function order_done(orderID) {
        ajax({
            type: "post",
            url: "/product/order/done",
            data: {"orderID": orderID},
            success: function () {
                load_orders();
            }
        });
    }

</script>
</html>