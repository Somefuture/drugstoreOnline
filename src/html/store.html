<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 视图窗口，移动端特属的标签。 -->
    <meta name="viewport"
          content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no"/>
    <!-- 是否启动webapp功能，会删除默认的苹果工具栏和菜单栏。 -->
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <!-- 这个主要是根据实际的页面设计的主体色为搭配来进行设置。 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black"/>
    <!-- 忽略页面中的数字识别为电话号码,email识别 -->
    <meta name="format-detection" content="telephone=no, email=no"/>
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
    <meta name="HandheldFriendly" content="true">
    <!-- 微软的老式浏览器 -->
    <meta name="MobileOptimized" content="320">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <!-- windows phone 点击无高光 -->
    <meta name="msapplication-tap-highlight" content="no">
    <title>精品商城</title>
    <link rel="stylesheet" href="../css/normalize.css">
    <link type="text/css" rel="stylesheet" href="../css/swiper.css" />
    <link type="text/css" rel="stylesheet" href="../css/sweetalert.css" />
    <link rel="stylesheet" href="../css/reset.css">
    <link rel="stylesheet" href="../css/index.css">
</head>
<body>
<div class="store_header">

    <div class="search">
        <img src="../images/tab/tab_07.png" alt="">
        <input type="search" placeholder="请输入要搜索的药品">
    </div>
    <button>搜药</button>
</div>
<div class="store_body">
    <div class="banner" id="banner"></div>
    <div class="category">
        <img src="../images/tab/store.jpg" alt="">
        <ul>
            <li>
                <img src="../images/tab/tab_11.png" alt="">
                感冒发烧
            </li>
            <li>
                <img src="../images/tab/tab_13.png" alt="">
                咳嗽用药
            </li>
            <li>
                <img src="../images/tab/tab_15.png" alt="">
                皮肤用药
            </li>
            <li>
                <img src="../images/tab/tab_17.png" alt="">
                妇科用药
            </li>
            <li>
                <img src="../images/tab/tab_23.png" alt="">
                肠胃用药
            </li>
            <li>
                <img src="../images/tab/tab_24.png" alt="">
                鼻炎用药
            </li>
            <li>
                <img src="../images/tab/tab_25.png" alt="">
                减肥瘦身
            </li>
            <li>
                <img src="../images/tab/tab_26.png" alt="">
                营养保健
            </li>
        </ul>
    </div>
    <div id="product_list">
        <a href="/products?drop=0&take=10" id="loadData"></a>
    </div>
</div>
<div class="footer">
    <ul class="nav">
        <li>
            <a href="index.html">
                <img src="../images/tab/tab_32.png" alt="">
                首页
            </a>
        </li>
        <li class="active">
            <a href="store.html">
                <img src="../images/tab/tab_49.png" alt="">
                精品商城
            </a>
        </li>
        <li>
            <a href="shoppingCar.html">
                <img src="../images/tab/tab_38.png" alt="">
                我的药箱
            </a>
        </li>
        <li>
            <a href="personal.html">
                <img src="../images/tab/tab_40.png" alt="">
                个人中心
            </a>
        </li>
    </ul>
</div>
</body>
<script type="text/template" id="banner_template">
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <% _.each(images, function (image) { %>
            <div class="swiper-slide">
                <!-- Required swiper-lazy class and image source specified in data-src attribute -->
                <img data-src="/file/public/<%= image.image.id %>.<%= image.image.ext %>" class="swiper-lazy">
                <!-- Preloader image -->
                <div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div>
            </div>
            <% }); %>
        </div>
        <!-- Add Pagination -->
        <div class="swiper-pagination swiper-pagination-white"></div>
    </div>
</script>
<script type="text/template" id="product_list_template">
    <div class="product_lists">
        <ul>
            <% _.each(success.list,function(ele){ %>
            <li>
                <a href="/html/productDetails.html?id=<%=ele.id%>">
                    <span class="pro_name"><%=ele.name%></span>
                    <div class="img"
                         style="background-image: url('/file/public/<%=ele.image.id%>.<%=ele.image.ext%>');">
                    </div>
                    <span class="pro_price">￥<%=ele.minSalesPrice%></span>
                    <span class="sale_volume">销量：<%=ele.salesVolume%></span>
                </a>
            </li>
            <% }) %>
        </ul>
        <% if(drop < success.count){ %>
        <a href="/products?drop=<%=drop%>&take=<%=take%>" id="loadData" class="bottom_info">--- 下拉加载更多数据 ---</a>
        <% } else { %>
            <span class="bottom_info">--- 没有更多了 ---</span>
        <% } %>
    </div>
</script>
<script src="../javascript/jquery-3.2.1.min.js"></script>
<script src="../javascript/sweetalert.min.js"></script>
<script src="../javascript/swiper.min.js"></script>
<script src="../javascript/underscore-1.8.3.min.js"></script>
<script src="../javascript/util.js"></script>
<script>
    render_banner();
    function render_banner() {
        $.ajax({
            url: "/advertisement/materials/by_collection",
            data: {"collectionID": 10},
            headers: {"X-Requested-With": "h5"},
            success: function (json) {
                if(json && json.error) {
                    swal("", json.error.message);
                }else {
                    var banner_template = _.template($("#banner_template").html());
                    $("#banner").html(banner_template({"images": json.success}));
                    new Swiper('.swiper-container', {
                        slidesPerView: 'auto',
                        centeredSlides: true,
                        autoplay: {
                            delay: 2500
                        },
                        lazy: true,
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true
                        }
                    });
                }
            },
            error: function (xhr, status, message) {
                if(message === "Unauthorized") {
                    window.location.href = "login.html";
                }else {
                    swal("", "系统繁忙，请稍后再试。");
                }
            }
        });
    }
    var product_list_template = _.template($("#product_list_template").html());
    $.getData = function (load_data_id) {
        var $load_data = $(load_data_id);
        if($load_data.length === 0){
            // todo : remove scroll event
            return;
        }
        var url = $load_data[0].getAttribute("href");
        var data = getJsonFromUrl(url);
        data.drop = parseInt(data.drop);
        data.take = parseInt(data.take);
        $.ajax({
            url: url,
            headers: {"X-Requested-With": "h5"},
            success: function (json) {
                if (json && json.error) {
                    swal("", json.error.message);
                } else {
                    data.success = json.success;
                    data.drop += 10;
                    $("#loadData")[0].remove();
                    $("#product_list").append(product_list_template(data));
                }
            },
            error: function (xhr, status, message) {
                if (message === "Unauthorized") {
                    window.location.href = "login.html";
                } else {
                    swal("", "系统繁忙，请稍后再试。");
                }
            }
        });
    };
    var load_data_id = "#loadData";
    var bottom_offset = 400;
    $.getData(load_data_id);
    var loadMore = _.debounce(function () {
        if (($(document).height() - $(window).scrollTop()) > bottom_offset) {
            $.getData(load_data_id);
        }
    }, 500);
    $(window).scroll(loadMore);
</script>
</html>