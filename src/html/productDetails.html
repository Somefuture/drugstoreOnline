<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <!-- 视图窗口，移动端特属的标签。 -->
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no" />
    <!-- 是否启动webapp功能，会删除默认的苹果工具栏和菜单栏。 -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <!-- 这个主要是根据实际的页面设计的主体色为搭配来进行设置。 -->
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <!-- 忽略页面中的数字识别为电话号码,email识别 -->
    <meta name="format-detection" content="telephone=no, email=no" />
    <!-- 启用360浏览器的极速模式(webkit) -->
    <meta name="renderer" content="webkit">
    <!-- 避免IE使用兼容模式 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- 针对手持设备优化，主要是针对一些老的不识别viewport的浏览器，比如黑莓 -->
    <meta name="HandheldFriendly" content="true">
    <!-- 微软的老式浏览器 -->
    <meta name="MobileOptimized" content="320">
    <!-- uc强制竖屏 -->
    <meta name="screen-orientation" content="portrait">
    <!-- QQ强制竖屏 -->
    <meta name="x5-orientation" content="portrait">
    <!-- UC强制全屏 -->
    <meta name="full-screen" content="yes">
    <!-- QQ强制全屏 -->
    <meta name="x5-fullscreen" content="true">
    <!-- UC应用模式 -->
    <meta name="browsermode" content="application">
    <!-- QQ应用模式 -->
    <meta name="x5-page-mode" content="app">
    <!-- windows phone 点击无高光 -->
    <meta name="msapplication-tap-highlight" content="no">
    <title>商品详情</title>
    <link type="text/css" rel="stylesheet" href="../css/normalize.css">
    <link type="text/css" rel="stylesheet" href="../css/swiper.css" />
    <link type="text/css" rel="stylesheet" href="../css/sweetalert.css" />
    <link type="text/css" rel="stylesheet" href="../css/index.css" />
    <link type="text/css" rel="stylesheet" href="../css/reset.css">
</head>
<body>
    <div class="detail_header">
        <img src="../images/details/tab_03.png" alt="">
        <div class="items">
            <span class="active"><a href="#">商品</a></span>
            <span><a href="specification.html">说明书</a></span>
            <span><a href="comment.html">评论</a></span>
        </div>
    </div>
    <div id="product_body"></div>
    <div class="detail_footer">
        <div class="consult">
            <img src="../images/details/shoppingcar_21.png" alt="">
            咨询
        </div><div class="shoppingCar">
            <img src="../images/details/shoppingcar_25.png" alt="">
            购物车
        </div><div class="addToCar">
            <img src="../images/details/shoppingcar_29.png" alt="">
            加入我的药箱
        </div><div class="nextStep">
            下一步
        </div>
    </div>
</body>
<script type="text/template" id="banner_template">
    <div class="swiper-container">
        <div class="swiper-wrapper">
            <% _.each(images, function (image) { %>
            <div class="swiper-slide">
                <!-- Required swiper-lazy class and image source specified in data-src attribute -->
                <img data-src="/file/public/<%= image.id %>.<%= image.ext %>" class="swiper-lazy">
                <!-- Preloader image -->
                <div class="swiper-lazy-preloader swiper-lazy-preloader-white"></div>
            </div>
            <% }); %>
        </div>
        <!-- Add Pagination -->
        <div class="swiper-pagination swiper-pagination-white"></div>
    </div>
</script>
<script type="text/template" id="product_template">
    <div class="detail_body">
        <div class="banner">
            <div id="banner"></div>
        </div>
        <div class="intro">
            <div class="intro_title">
                <%= product.name %>
            </div>
            <div class="intro_content">
                <%= product.description %>
            </div>
            <div class="intro_price">
                现价
                <span class="present_price"><%= product.minSalesPrice %></span>
            </div>
        </div>
        <ul class="detail_function">
            <li>
                <img src="../images/details/shoppingcar_17.png" alt="">
                <div>附近药店</div>
                <div class="toDetail">
                    <img src="../images/details/home_57@2x.png" alt="">
                </div>
            </li>
            <li>
                <div>选择（可选择规格 组合）</div>
                <div class="toDetail">
                    <img src="../images/details/home_57@2x.png" alt="">
                </div>
            </li>
            <li>
                <div>配送地</div>
                <div class="toDetail">
                    <img src="../images/details/home_57@2x.png" alt="">
                </div>
            </li>
        </ul>
        <div class="warning">
            温馨提醒：请按药品说明书或在药师指导下购买和使用。
        </div>
        <div class="particulars">
            下拉加载图文详情
        </div>
    </div>
</script>
<script src="../javascript/jquery-3.2.1.min.js"></script>
<script src="../javascript/sweetalert.min.js"></script>
<script src="../javascript/swiper.min.js"></script>
<script src="../javascript/underscore-1.8.3.min.js"></script>
<script src="../javascript/util.js"></script>
<script>
    var id = get_query_string("id");
    var product_template = _.template($("#product_template").html());
    get_product(id);
    function get_product(id) {
        $.ajax({
            url: "/product",
            data: {"id": id},
            headers: {"X-Requested-With": "h5"},
            success: function (json) {
                if(json && json.error) {
                    swal("", json.error.message);
                }else {
                    $("#product_body").html(product_template({"product": json.success}));
                    render_banner(id);
                }
            },
            error: function (xhr, status, message) {
                if(message === "Unauthorized") {
                    window.location.href = "login.html";
                }else {
                    swal("", "系统繁忙，请稍后再试。");
                }
            }
        });
    }
    function render_banner(id) {
        $.ajax({
            url: "/product/images",
            data: {"id": id},
            headers: {"X-Requested-With": "h5"},
            success: function (json) {
                if(json && json.error) {
                    swal("", json.error.message);
                }else {
                    var banner_template = _.template($("#banner_template").html());
                    $("#banner").html(banner_template({"images": json.success}));
                    new Swiper('.swiper-container', {
                        slidesPerView: 'auto',
                        centeredSlides: true,
                        autoplay: {
                            delay: 2500
                        },
                        lazy: true,
                        pagination: {
                            el: '.swiper-pagination',
                            clickable: true
                        }
                    });
                }
            },
            error: function (xhr, status, message) {
                if(message === "Unauthorized") {
                    window.location.href = "login.html";
                }else {
                    swal("", "系统繁忙，请稍后再试。");
                }
            }
        });
    }
</script>
</html>